{% extends "base.html" %}

{% block head %}
<style>
    .hero-section {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        border-radius: 16px;
        padding: 3rem 2rem;
        color: #fff;
        position: relative;
        overflow: hidden;
    }
    .hero-section::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -20%;
        width: 500px;
        height: 500px;
        background: radial-gradient(circle, rgba(13,110,253,.15) 0%, transparent 70%);
        border-radius: 50%;
    }
    .hero-section::after {
        content: '';
        position: absolute;
        bottom: -30%;
        left: -10%;
        width: 400px;
        height: 400px;
        background: radial-gradient(circle, rgba(25,135,84,.1) 0%, transparent 70%);
        border-radius: 50%;
    }
    .hero-subtitle { color: rgba(255,255,255,.7); }
    .stat-card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0,0,0,.06);
        transition: transform .15s, box-shadow .15s;
        height: 100%;
    }
    .stat-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 24px rgba(0,0,0,.1);
    }
    .stat-label {
        font-size: .72rem;
        text-transform: uppercase;
        letter-spacing: .8px;
        color: #6c757d;
        margin-bottom: .25rem;
    }
    .stat-value {
        font-size: 1.4rem;
        font-weight: 700;
    }
    .stat-icon {
        width: 42px;
        height: 42px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
        flex-shrink: 0;
    }
    .leaderboard-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: .65rem 0;
        border-bottom: 1px solid #f0f0f0;
    }
    .leaderboard-row:last-child { border-bottom: none; }
    .rank-badge {
        width: 26px;
        height: 26px;
        border-radius: 8px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: .75rem;
        font-weight: 700;
        margin-right: .6rem;
        flex-shrink: 0;
    }
    .rank-1 { background: linear-gradient(135deg, #ffd700, #ffaa00); color: #fff; }
    .rank-2 { background: linear-gradient(135deg, #c0c0c0, #a0a0a0); color: #fff; }
    .rank-3 { background: linear-gradient(135deg, #cd7f32, #b06820); color: #fff; }
    .rank-default { background: #e9ecef; color: #6c757d; }
    .nav-card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0,0,0,.06);
        transition: transform .15s, box-shadow .15s;
        text-decoration: none;
        color: inherit;
        display: block;
        height: 100%;
    }
    .nav-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 24px rgba(0,0,0,.1);
        color: inherit;
    }
    .nav-card .card-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.3rem;
        margin-bottom: .75rem;
    }
    .strategy-bar {
        height: 8px;
        border-radius: 4px;
        background: #e9ecef;
        overflow: hidden;
    }
    .strategy-bar-fill {
        height: 100%;
        border-radius: 4px;
        transition: width .3s ease;
    }
    .chart-wrapper {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0,0,0,.06);
        padding: 1.25rem;
    }
</style>
{% endblock %}

{% block content %}

{% if not has_accounts %}
<div class="alert alert-warning d-flex align-items-center mb-4" role="alert">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="me-2 flex-shrink-0" viewBox="0 0 16 16">
        <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
    </svg>
    <div>
        <strong>No data yet.</strong>
        Upload your Schwab trade history and current positions to see your portfolio, strategies, and insights.
        <a href="{{ url_for('upload') }}" class="alert-link ms-1">Upload now →</a>
    </div>
</div>
{% endif %}

{# ── Hero Section ── #}
<div class="hero-section mb-4">
    <div class="row align-items-center position-relative" style="z-index:1">
        <div class="col-lg-7">
            <h1 class="display-4 fw-bold mb-2">HappyTrader</h1>
            <p class="hero-subtitle lead mb-4">
                Track your options strategies, measure performance, and see what's working
                across every position, account, and strategy.
            </p>
            <div class="d-flex gap-2 flex-wrap">
                <a href="/positions" class="btn btn-light btn-lg px-4 fw-semibold">
                    View Positions
                </a>
                <a href="/accounts" class="btn btn-outline-light btn-lg px-4">
                    Account Performance
                </a>
            </div>
        </div>
        {% if stats %}
        <div class="col-lg-5 mt-4 mt-lg-0">
            <div class="row g-3">
                <div class="col-6">
                    <div class="p-3 rounded-3" style="background:rgba(255,255,255,.08)">
                        <div class="small text-white-50 mb-1">Total Return</div>
                        <div class="h4 mb-0 {% if stats.total_return >= 0 %}text-success{% else %}text-danger{% endif %}">
                            ${{ "{:,.2f}".format(stats.total_return) }}
                        </div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="p-3 rounded-3" style="background:rgba(255,255,255,.08)">
                        <div class="small text-white-50 mb-1">Win Rate</div>
                        <div class="h4 mb-0 text-white">
                            {{ "{:.1f}%".format(stats.win_rate * 100) }}
                        </div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="p-3 rounded-3" style="background:rgba(255,255,255,.08)">
                        <div class="small text-white-50 mb-1">Symbols</div>
                        <div class="h4 mb-0 text-white">{{ stats.num_symbols }}</div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="p-3 rounded-3" style="background:rgba(255,255,255,.08)">
                        <div class="small text-white-50 mb-1">Total Trades</div>
                        <div class="h4 mb-0 text-white">{{ "{:,}".format(stats.total_trades) }}</div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

{% if stats %}
{# ── KPI Cards ── #}
<div class="row g-3 mb-4">
    <div class="col-sm-6 col-lg-3">
        <div class="card stat-card p-3">
            <div class="d-flex align-items-center gap-3">
                <div class="stat-icon" style="background:rgba(25,135,84,.1); color:#198754">$</div>
                <div>
                    <div class="stat-label">Realized P&amp;L</div>
                    <div class="stat-value {% if stats.realized_pnl >= 0 %}text-positive{% else %}text-negative{% endif %}">
                        ${{ "{:,.2f}".format(stats.realized_pnl) }}
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-sm-6 col-lg-3">
        <div class="card stat-card p-3">
            <div class="d-flex align-items-center gap-3">
                <div class="stat-icon" style="background:rgba(13,110,253,.1); color:#0d6efd">~</div>
                <div>
                    <div class="stat-label">Unrealized P&amp;L</div>
                    <div class="stat-value {% if stats.unrealized_pnl >= 0 %}text-positive{% else %}text-negative{% endif %}">
                        ${{ "{:,.2f}".format(stats.unrealized_pnl) }}
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-sm-6 col-lg-3">
        <div class="card stat-card p-3">
            <div class="d-flex align-items-center gap-3">
                <div class="stat-icon" style="background:rgba(111,66,193,.1); color:#6f42c1">P</div>
                <div>
                    <div class="stat-label">Premium Collected</div>
                    <div class="stat-value text-positive">
                        ${{ "{:,.2f}".format(stats.premium_collected) }}
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-sm-6 col-lg-3">
        <div class="card stat-card p-3">
            <div class="d-flex align-items-center gap-3">
                <div class="stat-icon" style="background:rgba(255,193,7,.1); color:#ffc107">D</div>
                <div>
                    <div class="stat-label">Dividend Income</div>
                    <div class="stat-value text-positive">
                        ${{ "{:,.2f}".format(stats.dividend_income) }}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{# ── Portfolio P&L Chart ── #}
{% if portfolio_chart_json and portfolio_chart_json != '{}' %}
{% set pc = portfolio_chart_json | safe %}
<div class="chart-wrapper mb-4">
    <h6 class="fw-bold mb-3">Portfolio Performance</h6>
    <div style="height: 300px;">
        <canvas id="portfolioChart"></canvas>
    </div>
</div>
{% endif %}

{# ── AI Insights Card ── #}
{% if insight %}
<div class="card stat-card p-4 mb-4">
    <div class="d-flex justify-content-between align-items-start mb-2">
        <h5 class="fw-bold mb-0">AI Trading Insights</h5>
        <a href="{{ url_for('insights') }}" class="btn btn-sm btn-outline-primary">View Full Analysis</a>
    </div>
    <p class="mb-1">{{ insight.summary }}</p>
    <span class="text-muted" style="font-size:.75rem">Generated {{ insight.generated_at }}</span>
</div>
{% elif has_accounts %}
<div class="card stat-card p-4 mb-4">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h5 class="fw-bold mb-1">AI Trading Insights</h5>
            <p class="text-muted mb-0 small">Get a personalized analysis of your trading style and performance.</p>
        </div>
        <a href="{{ url_for('insights') }}" class="btn btn-primary btn-sm">Generate Insights</a>
    </div>
</div>
{% endif %}

<div class="row g-4 mb-4">
    {# ── Top Symbols Leaderboard ── #}
    {% if top_symbols %}
    <div class="col-lg-6">
        <div class="card stat-card p-4">
            <h5 class="fw-bold mb-3">Top Performing Symbols</h5>
            {% for sym in top_symbols %}
            <div class="leaderboard-row">
                <div class="d-flex align-items-center">
                    <span class="rank-badge {% if loop.index == 1 %}rank-1{% elif loop.index == 2 %}rank-2{% elif loop.index == 3 %}rank-3{% else %}rank-default{% endif %}">
                        {{ loop.index }}
                    </span>
                    <div>
                        <a href="{{ url_for('position_detail', symbol=sym.symbol) }}" class="fw-semibold text-decoration-none">{{ sym.symbol }}</a>
                        <div class="text-muted small">{{ sym.strategies }}</div>
                    </div>
                </div>
                <div class="fw-bold {% if sym.total_return >= 0 %}text-positive{% else %}text-negative{% endif %}">
                    ${{ "{:,.2f}".format(sym.total_return) }}
                </div>
            </div>
            {% endfor %}
            <a href="/positions" class="btn btn-sm btn-outline-primary mt-3">View All Positions</a>
        </div>
    </div>
    {% endif %}

    {# ── Strategy Breakdown ── #}
    {% if strategy_breakdown %}
    <div class="col-lg-6">
        <div class="card stat-card p-4">
            <h5 class="fw-bold mb-3">Strategy Breakdown</h5>
            {% set max_return = strategy_breakdown | map(attribute='total_return') | map('abs') | max %}
            {% for strat in strategy_breakdown %}
            <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <div>
                        <span class="fw-semibold">{{ strat.strategy }}</span>
                        <span class="text-muted small ms-2">{{ strat.num_symbols | int }} symbols</span>
                    </div>
                    <span class="fw-bold {% if strat.total_return >= 0 %}text-positive{% else %}text-negative{% endif %}">
                        ${{ "{:,.2f}".format(strat.total_return) }}
                    </span>
                </div>
                <div class="strategy-bar">
                    {% if max_return > 0 %}
                    <div class="strategy-bar-fill {% if strat.total_return >= 0 %}bg-success{% else %}bg-danger{% endif %}"
                         style="width: {{ (strat.total_return | abs / max_return * 100) | round(1) }}%"></div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
            <a href="/positions" class="btn btn-sm btn-outline-primary mt-2">Explore Strategies</a>
        </div>
    </div>
    {% endif %}
</div>
{% endif %}

{# ── Quick Navigation Cards ── #}
<div class="row g-4 mb-4">
    <div class="col-md-4">
        <a href="/positions" class="nav-card card p-4">
            <div class="card-icon" style="background:rgba(13,110,253,.1); color:#0d6efd">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M4 11H2v3h2zm5-4H7v7h2zm5-5h-2v12h2zm-2-1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h2a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1zM6 7a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v7a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1zm-5 4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1z"/>
                </svg>
            </div>
            <h5 class="fw-bold mb-1">Positions Dashboard</h5>
            <p class="text-muted small mb-0">
                KPI cards, strategy P&amp;L charts, and a sortable data table with
                filtering by account, strategy, status, and date range.
            </p>
        </a>
    </div>
    <div class="col-md-4">
        <a href="/symbols" class="nav-card card p-4">
            <div class="card-icon" style="background:rgba(25,135,84,.1); color:#198754">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M0 0h1v15h15v1H0zm14.817 3.113a.5.5 0 0 1 .07.704l-4.5 5.5a.5.5 0 0 1-.74.037L7.06 6.767l-3.656 5.027a.5.5 0 0 1-.808-.588l4-5.5a.5.5 0 0 1 .758-.06l2.609 2.61 4.15-5.073a.5.5 0 0 1 .704-.07"/>
                </svg>
            </div>
            <h5 class="fw-bold mb-1">Daily Detail</h5>
            <p class="text-muted small mb-0">
                Per-symbol trade history, current positions, and cumulative
                P&amp;L charts broken down by equity, options, and dividends.
            </p>
        </a>
    </div>
    <div class="col-md-4">
        <a href="/accounts" class="nav-card card p-4">
            <div class="card-icon" style="background:rgba(111,66,193,.1); color:#6f42c1">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M12.136.326A1.5 1.5 0 0 1 14 1.78V3h.5A1.5 1.5 0 0 1 16 4.5v9a1.5 1.5 0 0 1-1.5 1.5h-13A1.5 1.5 0 0 1 0 13.5v-9a1.5 1.5 0 0 1 1.432-1.499zM5.562 3H13V1.78a.5.5 0 0 0-.621-.484zM1.5 4a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h13a.5.5 0 0 0 .5-.5v-9a.5.5 0 0 0-.5-.5z"/>
                </svg>
            </div>
            <h5 class="fw-bold mb-1">Account Performance</h5>
            <p class="text-muted small mb-0">
                Account-level KPIs, cumulative P&amp;L over time, and strategy
                performance comparison across all your brokerage accounts.
            </p>
        </a>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
(function () {
    var chartData = {{ portfolio_chart_json | safe }};
    var canvas = document.getElementById('portfolioChart');
    if (canvas && chartData.dates && chartData.dates.length > 0) {
        new Chart(canvas, {
            type: 'line',
            data: {
                labels: chartData.dates,
                datasets: [
                    {
                        label: 'Total',
                        data: chartData.total,
                        borderColor: '#1a1a2e',
                        backgroundColor: 'rgba(26,26,46,.08)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 0,
                        pointHitRadius: 6,
                        borderWidth: 2.5,
                        order: 0
                    },
                    {
                        label: 'Equity',
                        data: chartData.equity,
                        borderColor: '#0d6efd',
                        tension: 0.3,
                        pointRadius: 0,
                        pointHitRadius: 6,
                        borderWidth: 1.5,
                        order: 1
                    },
                    {
                        label: 'Options',
                        data: chartData.options,
                        borderColor: '#6f42c1',
                        tension: 0.3,
                        pointRadius: 0,
                        pointHitRadius: 6,
                        borderWidth: 1.5,
                        order: 2
                    },
                    {
                        label: 'Dividends',
                        data: chartData.dividends,
                        borderColor: '#198754',
                        tension: 0.3,
                        pointRadius: 0,
                        pointHitRadius: 6,
                        borderWidth: 1.5,
                        order: 3
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(ctx) {
                                return ctx.dataset.label + ': $' +
                                    ctx.parsed.y.toLocaleString(undefined, {minimumFractionDigits: 2});
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: { maxTicksLimit: 10 }
                    },
                    y: {
                        ticks: {
                            callback: function(v) {
                                return '$' + (Math.abs(v) >= 1000
                                    ? (v / 1000).toFixed(1) + 'k'
                                    : v.toFixed(0));
                            }
                        },
                        grid: {
                            color: function(ctx) {
                                return ctx.tick.value === 0 ? '#000' : '#e9ecef';
                            }
                        }
                    }
                }
            }
        });
    }
})();
</script>
{% endblock %}
