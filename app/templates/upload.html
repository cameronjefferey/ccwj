{% extends "base.html" %}

{% block head %}
<style>
    .upload-zone {
        border: 2px dashed #ced4da;
        border-radius: 12px;
        padding: 2rem;
        text-align: center;
        transition: border-color .2s, background .2s;
        cursor: pointer;
        position: relative;
    }
    .upload-zone:hover, .upload-zone.drag-over {
        border-color: #0d6efd;
        background: rgba(13,110,253,.04);
    }
    .upload-zone.has-file {
        border-color: #198754;
        background: rgba(25,135,84,.04);
    }
    .upload-zone input[type="file"] {
        position: absolute;
        inset: 0;
        opacity: 0;
        cursor: pointer;
    }
    .upload-icon {
        font-size: 2rem;
        color: #6c757d;
        margin-bottom: .5rem;
    }
    .upload-zone.has-file .upload-icon { color: #198754; }
    .file-name {
        font-weight: 600;
        color: #198754;
        font-size: .9rem;
    }
    .format-table {
        font-size: .78rem;
    }
    .format-table th {
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: .5px;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-9">
        <h2 class="fw-bold mb-1">Upload Portfolio Data</h2>
        <p class="text-muted mb-4">
            Upload your trade history and current positions as CSV files.
            Data will be loaded into BigQuery and the dbt pipeline will be triggered automatically.
        </p>

        <form method="POST" action="{{ url_for('upload') }}" enctype="multipart/form-data" id="uploadForm">
            <div class="row g-4 mb-4">
                {# ── History CSV ── #}
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm" style="border-radius:12px">
                        <div class="card-body">
                            <h5 class="fw-bold mb-3">Trade History</h5>
                            <div class="upload-zone" id="historyZone">
                                <input type="file" name="history_csv" id="historyFile" accept=".csv">
                                <div class="upload-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/>
                                        <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/>
                                    </svg>
                                </div>
                                <div class="upload-text">
                                    <span class="text-muted">Drop your history CSV here or click to browse</span>
                                </div>
                                <div class="file-name mt-2" id="historyFileName" style="display:none"></div>
                            </div>
                            <div class="mt-3">
                                <p class="text-muted small mb-2">Expected columns:</p>
                                <table class="table table-sm format-table mb-0">
                                    <tbody>
                                        <tr><td><code>Date</code></td><td>Trade date (MM/DD/YYYY)</td></tr>
                                        <tr><td><code>Action</code></td><td>Buy, Sell, Sell to Open, etc.</td></tr>
                                        <tr><td><code>Symbol</code></td><td>Ticker or option symbol</td></tr>
                                        <tr><td><code>Description</code></td><td>Security description</td></tr>
                                        <tr><td><code>Quantity</code></td><td>Number of shares/contracts</td></tr>
                                        <tr><td><code>Price</code></td><td>Price per unit</td></tr>
                                        <tr><td><code>Fees &amp; Comm</code></td><td>Fees and commissions</td></tr>
                                        <tr><td><code>Amount</code></td><td>Total transaction amount</td></tr>
                                    </tbody>
                                </table>
                                <p class="text-muted small mt-2 mb-0">
                                    The <code>Account</code> column is set from the dropdown below.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                {# ── Current CSV ── #}
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm" style="border-radius:12px">
                        <div class="card-body">
                            <h5 class="fw-bold mb-3">Current Positions</h5>
                            <div class="upload-zone" id="currentZone">
                                <input type="file" name="current_csv" id="currentFile" accept=".csv">
                                <div class="upload-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/>
                                        <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/>
                                    </svg>
                                </div>
                                <div class="upload-text">
                                    <span class="text-muted">Drop your current positions CSV here or click to browse</span>
                                </div>
                                <div class="file-name mt-2" id="currentFileName" style="display:none"></div>
                            </div>
                            <div class="mt-3">
                                <p class="text-muted small mb-2">
                                    Export your positions from the brokerage. Headers should be on <strong>row 3</strong>. Key columns:
                                </p>
                                <table class="table table-sm format-table mb-0">
                                    <tbody>
                                        <tr><td><code>Symbol</code></td><td>Ticker or option symbol</td></tr>
                                        <tr><td><code>Description</code></td><td>Security description</td></tr>
                                        <tr><td><code>Qty</code></td><td>Number held</td></tr>
                                        <tr><td><code>Price</code></td><td>Current price</td></tr>
                                        <tr><td><code>Security Type</code></td><td>Equity, Option, etc.</td></tr>
                                    </tbody>
                                </table>
                                <p class="text-muted small mt-2 mb-0">
                                    All other brokerage columns (Mkt Val, Cost Basis, Gain $, etc.) are carried through automatically. The <code>Account</code> is set from the dropdown below.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {# ── Account Name (mandatory) ── #}
            <div class="row justify-content-center mb-4">
                <div class="col-md-8">
                    <div class="card border-0 shadow-sm p-4" style="border-radius:12px">
                        <h6 class="fw-bold mb-2">Account Name <span class="text-danger">*</span></h6>
                        <p class="text-muted small mb-2">
                            Select an existing account or create a new one. This will be applied to all
                            rows in both CSV files.
                        </p>
                        <select class="form-select mb-2" name="account_name" id="accountSelect">
                            <option value="" selected>-- Select an account --</option>
                            {% for acct in accounts %}
                            <option value="{{ acct }}">{{ acct }}</option>
                            {% endfor %}
                            <option value="__new__">+ Create new account...</option>
                        </select>
                        <input type="text" class="form-control" name="account_name_custom"
                               id="accountCustom" placeholder="Enter new account name"
                               style="display:none">
                    </div>
                </div>
            </div>

            <div class="text-center">
                <button type="submit" class="btn btn-primary btn-lg px-5" id="submitBtn" disabled>
                    Upload &amp; Trigger Pipeline
                </button>
                <p class="text-muted small mt-2">
                    Both files are required. Existing data for the uploaded accounts will be replaced.
                </p>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // File selection feedback and drag-and-drop
    function setupZone(zoneId, inputId, nameId) {
        const zone = document.getElementById(zoneId);
        const input = document.getElementById(inputId);
        const nameEl = document.getElementById(nameId);

        input.addEventListener('change', () => {
            if (input.files.length) {
                zone.classList.add('has-file');
                nameEl.textContent = input.files[0].name;
                nameEl.style.display = 'block';
                zone.querySelector('.upload-text').style.display = 'none';
                checkReady();
            }
        });

        zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('drag-over'); });
        zone.addEventListener('dragleave', () => { zone.classList.remove('drag-over'); });
        zone.addEventListener('drop', (e) => {
            e.preventDefault();
            zone.classList.remove('drag-over');
            if (e.dataTransfer.files.length) {
                input.files = e.dataTransfer.files;
                input.dispatchEvent(new Event('change'));
            }
        });
    }

    function checkReady() {
        const h = document.getElementById('historyFile').files.length > 0;
        const c = document.getElementById('currentFile').files.length > 0;
        const sel = document.getElementById('accountSelect');
        const custom = document.getElementById('accountCustom');
        const hasAccount = (sel.value && sel.value !== '' && sel.value !== '__new__')
                        || (sel.value === '__new__' && custom.value.trim() !== '');
        document.getElementById('submitBtn').disabled = !(h && c && hasAccount);
    }

    // Account select: show/hide custom input
    const accountSelect = document.getElementById('accountSelect');
    const accountCustom = document.getElementById('accountCustom');
    accountSelect.addEventListener('change', () => {
        if (accountSelect.value === '__new__') {
            accountCustom.style.display = 'block';
            accountCustom.focus();
        } else {
            accountCustom.style.display = 'none';
            accountCustom.value = '';
        }
        checkReady();
    });
    accountCustom.addEventListener('input', checkReady);

    setupZone('historyZone', 'historyFile', 'historyFileName');
    setupZone('currentZone', 'currentFile', 'currentFileName');

    // Disable button and show spinner on submit
    document.getElementById('uploadForm').addEventListener('submit', () => {
        const btn = document.getElementById('submitBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Uploading...';
    });
</script>
{% endblock %}
