{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <h2 class="mb-4 text-center">ðŸ“Š Position Performance</h2>

    {% if charts %}
        <div class="accordion" id="positionsAccordion">
            {% for symbol, rows in charts.items() %}
                <div class="accordion-item">
                    <h2 class="accordion-header" id="heading-{{ loop.index }}">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ loop.index }}" aria-expanded="false" aria-controls="collapse-{{ loop.index }}">
                            {{ symbol }}
                        </button>
                    </h2>
                    <div id="collapse-{{ loop.index }}" class="accordion-collapse collapse" aria-labelledby="heading-{{ loop.index }}" data-bs-parent="#positionsAccordion">
                        <div class="accordion-body">
                            <div style="height: 300px; overflow-x: auto;">
                                <canvas id="chart-{{ loop.index0 }}" style="min-width: 700px;"></canvas>
                            </div>
                            <script>
                                document.addEventListener("DOMContentLoaded", function () {
                                    const chartData = {{ rows | tojson }};
                                    const labels = [...new Set(chartData.map(d => d.day))];
                                    const types = [...new Set(chartData.map(d => d.security_type))];

                                    const datasets = types.map(type => {
                                        return {
                                            label: type,
                                            data: labels.map(day => {
                                                const entry = chartData.find(r => r.day === day && r.security_type === type);
                                                return entry ? entry.gain_or_loss : null;
                                            }),
                                            fill: false,
                                            borderColor: type === "Options Sold" ? "#007bff" : "#ff6384",
                                            backgroundColor: type === "Options Sold" ? "#007bff" : "#ff6384",
                                            tension: 0.3
                                        };
                                    });

                                    const ctx = document.getElementById("chart-{{ loop.index0 }}").getContext("2d");
                                    new Chart(ctx, {
                                        type: "line",
                                        data: {
                                            labels: labels,
                                            datasets: datasets
                                        },
                                        options: {
                                            responsive: true,
                                            maintainAspectRatio: false,
                                            plugins: {
                                                title: {
                                                    display: true,
                                                    text: "Daily Gain or Loss"
                                                },
                                                tooltip: {
                                                    mode: 'index',
                                                    intersect: false
                                                }
                                            },
                                            scales: {
                                                x: {
                                                    title: {
                                                        display: true,
                                                        text: "Date"
                                                    }
                                                },
                                                y: {
                                                    title: {
                                                        display: true,
                                                        text: "Gain or Loss ($)"
                                                    }
                                                }
                                            }
                                        }
                                    });
                                });
                            </script>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="alert alert-warning">No data found.</div>
    {% endif %}
</div>
{% endblock %}
