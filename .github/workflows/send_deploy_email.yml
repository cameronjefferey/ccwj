name: Send Deploy Email

on:
  workflow_dispatch:

jobs:
  send-email:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Read and convert deploy.txt to HTML
        id: deploy_notes
        run: |
          RAW=$(cat deploy.txt)

          HTML=$(echo "$RAW" | awk '
            BEGIN {
              print "<h3>ðŸš€ Deployment Notes</h3>"
            }
            /^$/ { print ""; next }
            /^[A-Za-z ]+$/ { print "<h4>" $0 "</h4>"; next }
            /^-/ { sub(/^- /, ""); print "<li>" $0 "</li>"; next }
            { print "<p>" $0 "</p>" }
          ' | awk '
            BEGIN { in_ul = 0 }
            /<li>/ {
              if (!in_ul) {
                print "<ul>"
                in_ul = 1
              }
              print
              next
            }
            {
              if (in_ul) {
                print "</ul>"
                in_ul = 0
              }
              print
            }
            END {
              if (in_ul) print "</ul>"
            }
          ')

          echo "message<<EOF" >> $GITHUB_OUTPUT
          echo "$HTML" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send Email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "ðŸš€ HappyTrader Deployment Notes"
          to: cameronjsmith@gmail.com
          from: "HappyTrader Bot <cameronjsmith23@gmail.com>"
          content_type: text/html
          body: ${{ steps.deploy_notes.outputs.message }}
